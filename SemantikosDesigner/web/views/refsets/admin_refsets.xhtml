<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:smtk="http://java.sun.com/jsf/composite/smtk"
                template="/WEB-INF/template.xhtml">

    <ui:define name="header">
        <p:breadCrumb>
            <p:menuitem value="Inicio" url="/views/home.xhtml" />
            <p:menuitem value="Administración RefSets" url="#" />
        </p:breadCrumb>
    </ui:define>

    <ui:define name="content">

        <p:panel id="refsetsAdmin">

            <h:form id="formRefset">

                <p:breadCrumb>
                    <p:menuitem value="Inicio" url="/views/home.xhtml" />
                    <p:menuitem value="RefSets" url="#" />
                </p:breadCrumb>

                <p:growl id="msg" showDetail="true" autoUpdate="true"/>

                <p:tabView>

                    <!--Pestaña crear RefSet-->
                    <p:tab title="Crear RefSet">

                        <div class="ui-g">
                            <div class="ui-g-12 ui-md-6 ui-lg-1">
                                <h:outputLabel value="Nombre:" style="font-weight:bold"/>
                            </div>
                            <div class="ui-g-12 ui-md-6 ui-lg-4">
                                <p:inputText value="#{refsetsBean.refSetToCreate.name}" style="width: 80%;"/>
                            </div>
                            <div class="ui-g-12 ui-md-6 ui-lg-1">
                                <h:outputLabel value="Tipo:" style="font-weight:bold"/>
                            </div>
                            <div class="ui-g-12 ui-md-6 ui-lg-4">
                                <p:selectOneMenu value="#{refsetsBean.refSetToCreate.institution}" var="i"
                                                 converter="omnifaces.SelectItemsConverter">
                                    <f:selectItem itemValue="" itemLabel="Seleccione una institución"
                                                  noSelectionOption="true"/>
                                    <f:selectItems value="#{refsetsBean.authenticationBean.loggedUser.institutions}"
                                                   var="institution" itemValue="#{institution}"
                                                   itemLabel="#{institution.name}"/>
                                    <p:column><h:outputText value="#{i.name}"/></p:column>
                                </p:selectOneMenu>
                            </div>
                        </div>

                        <p:fieldset legend="Conceptos" toggleable="true">

                            <div class="ui-g ui-fluid">

                                <div class="ui-g-12">

                                    <p:commandButton style="width: auto; right: right"
                                                     icon="fa fa-plus"
                                                     title="Agregar Conceptos"
                                                     value="Agregar Conceptos"
                                                     oncomplete="PF('selectConceptCreate').show()"
                                                     update="@(.selectConcept)"
                                                     disabled="#{not refsetsBean.refSetToCreate.valid}">
                                        <f:setPropertyActionListener value="" target="#{findConceptBean.pattern}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.categorySelected}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{refsetsBean.conceptSMTKListSelected}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.selectedCategories}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.findConcepts}"/>

                                    </p:commandButton>

                                </div>

                            </div>

                            <smtk:conceptRefset scroll="false" refset="#{refsetsBean.refSetToCreate}"/>

                            <div class="Fleft SoftBlue White  Container100 MarAuto Responsive"
                                 style="text-align: right;">
                                <br/>
                                <i class="fa fa-info-circle  SoftBlue"/> El RefSet puede ser creado sin conceptos
                                <br/>
                            </div>


                        </p:fieldset>

                        <br/>

                        <div style="text-align: center;">
                            <h3><p:commandButton value="Crear RefSet" actionListener="#{refsetsBean.createRefset}"
                                                 update="refsetsAdmin"/></h3>
                        </div>


                    </p:tab>

                    <!--Pestaña de administración de los RefSets-->
                    <p:tab title="Administrador de RefSets">
                        <p:dataTable id="refsetsTable" value="#{refsetsBean.refSetList}" var="refset"
                                     rows="15" paginator="true" emptyMessage="No se han creado Refsets"
                                     styleClass="listRefSets" filteredValue="#{refsetsBean.refsetFilter}">

                            <p:column headerText="ID" sortBy="#{refset.id}">
                                <h:outputText value="#{refset.id}"/>
                            </p:column>

                            <p:column headerText="Nombre" filterBy="#{refset.name}"
                                      filterMatchMode="contains" sortBy="#{refset.name}">
                                <h:outputText value="#{refset.name}"/>
                            </p:column>

                            <p:column headerText="Tipo" sortBy="#{refset.institution.name}">
                                <h:outputText value="#{refset.institution.name}"/>
                            </p:column>

                            <p:column headerText="Fecha de creación" sortBy="#{refset.creationDate}">
                                <h:outputText value="#{refset.getDateCreationFormat()}"/>
                            </p:column>

                            <p:column headerText="Vigencia" sortBy="#{refset.isValid()}">
                                <h:outputText value="Vigente" rendered="#{refset.isValid()}"/>
                                <h:outputText value="No vigente" rendered="#{!refset.isValid()}"/>
                            </p:column>

                            <p:column headerText="Acción">
                                <div style="text-align: center">
                                    <p:commandButton icon="fa fa-edit" update="@(.editRefset)"
                                                     oncomplete="PF('editRefset').show()" title="Editar">
                                        <f:setPropertyActionListener value="#{refset}"
                                                                     target="#{refsetsBean.refSetEdit}"/>
                                    </p:commandButton>
                                    <p:commandButton title="Consultar" icon="fa fa-search" oncomplete="PF('viewRefset').show()"
                                                     update="@(.viewRefSet)"
                                                     actionListener="#{refsetsBean.loadHistoryRefset(refset)}">
                                        <f:setPropertyActionListener value="#{refset}"
                                                                     target="#{refsetsBean.refSetSelect}"/>
                                    </p:commandButton>

                                    <p:commandButton title="Dejar no vigente" icon="fa fa-trash"
                                                     actionListener="#{refsetsBean.invalidRefset(refset)}"
                                                     update="@(.listRefSets)" rendered="#{refset.valid}">
                                        <p:confirm header="Confirmar Acción" message="¿Desea invalidar este RefSet?"
                                                   icon="ui-icon-alert"/>

                                    </p:commandButton>
                                </div>

                            </p:column>

                        </p:dataTable>
                    </p:tab>

                </p:tabView>


                <!-- Consultar conceptos de  un RefSet -->

                <p:dialog widgetVar="viewRefset"  showEffect="fade"
                          hideEffect="fade" resizable="true" style="margin:40px;"
                          header="Consultar RefSet">

                    <p:outputPanel id="viewRefsetPanel" styleClass="viewRefSet">

                        <div class="ui-fluid ui-g">

                            <div class="ui-g-12 ui-md-4 ui-lg-2">
                                <p:outputLabel styleClass="label" value="RefSet:"/>
                            </div>
                            <div class="ui-g-12 ui-md-8 ui-lg-4">
                                <p:outputLabel styleClass="value" value="#{refsetsBean.refSetSelect.name}"/>
                            </div>
                            <div class="ui-g-12 ui-md-4 ui-lg-2">
                                <p:outputLabel styleClass="label" value="Establecimiento:"/>
                            </div>
                            <div class="ui-g-12 ui-md-8 ui-lg-4">
                                <p:outputLabel styleClass="value" value="#{refsetsBean.refSetSelect.institution.name}"/>
                            </div>
                            <div class="ui-g-12 ui-md-4 ui-lg-2">
                                <p:outputLabel styleClass="label" value="Vigencia:"/>
                            </div>
                            <div class="ui-g-12 ui-md-8 ui-lg-4">
                                <p:outputLabel styleClass="value" value="#{refsetsBean.refSetSelect.valid?'Vigente':'No vigente'}"/>
                            </div>
                            <div class="ui-g-9 ui-md-9 ui-lg-9">
                                <p:outputLabel value="Total Conceptos: #{refsetsBean.refSetSelect.getCountConcepts()}"
                                               style="font-size: small"/>
                            </div>
                            <div class="ui-g-3 ui-md-3 ui-lg-3">
                                <p:commandButton ajax="false" icon="fa fa-file-excel-o" style="float: right">
                                    <p:dataExporter type="xls" target="conceptos" fileName="#{refsetsBean.refSetSelect.name}" />
                                </p:commandButton>
                            </div>

                            <div class="ui-g-12 ui-md-12 ui-lg-12">

                                <p:dataTable id="conceptos" value="#{refsetsBean.refSetSelect.concepts}" var="concepts" reflow="true"
                                             emptyMessage="El RefSet no contiene conceptos"
                                             scrollable="true" scrollHeight="150">
                                    <p:column headerText="ConceptID">
                                        <h:outputText value="#{concepts.conceptID}"/>
                                    </p:column>
                                    <p:column headerText="Termino Preferida">
                                        <h:outputText value="#{concepts.descriptionFavorite.term}"/>
                                    </p:column>
                                    <p:column headerText="Categoría">
                                        <h:outputText value="#{concepts.category.name}"/>
                                    </p:column>
                                    <p:column headerText="Fecha ingreso">
                                        <h:outputText value="#{refsetsBean.conceptBindToRefsetHistory.get(concepts.id).getActionDateFormat()}"/>
                                    </p:column>
                                </p:dataTable>

                            </div>
                        </div>
                    </p:outputPanel>
                </p:dialog>

                <!-- Editar Refset-->

                <p:dialog widgetVar="editRefset"  showEffect="fade"
                          header="Editar RefSet"
                          hideEffect="fade" resizable="true" style="margin:40px;">
                    <p:outputPanel id="editRefsetPanel" styleClass="editRefset">
                        <div class="ui-fluid">
                            <div class="ui-g">
                                <div class="ui-g-12 ui-md-4 ui-lg-2">
                                    <p:outputLabel styleClass="label" value="RefSet:"/>
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-4">
                                    <p:outputLabel styleClass="value" value="#{refsetsBean.refSetEdit.name}"/>
                                </div>
                                <div class="ui-g-12 ui-md-4 ui-lg-2">
                                    <p:outputLabel styleClass="label" value="Establecimiento:"/>
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-4">
                                    <p:outputLabel styleClass="value" value="#{refsetsBean.refSetEdit.institution.name}"/>
                                </div>
                                <div class="ui-g-12 ui-md-4 ui-lg-2">
                                    <p:outputLabel styleClass="label" value="Vigencia:"/>
                                </div>
                                <div class="ui-g-12 ui-md-8 ui-lg-4">
                                    <p:outputLabel styleClass="value" value="#{refsetsBean.refSetEdit.valid?'Vigente':'No vigente'}"/>
                                </div>
                                <div class="ui-g-9 ui-md-9 ui-lg-9">
                                    <p:outputLabel value="Total Conceptos: #{refsetsBean.refSetEdit.getCountConcepts()}"
                                    style="font-size: small"/>
                                </div>
                                <div class="ui-g-3 ui-md-3 ui-lg-3">
                                    <p:commandButton icon="fa fa-plus" style="float: right;"
                                                     oncomplete="PF('selectConcept').show()"
                                                     update="@(.selectConcept)"
                                                     rendered="#{refsetsBean.refSetEdit.valid}">

                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.pattern}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.categorySelected}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.selectedCategories}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{refsetsBean.conceptSMTKListSelected}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{refsetsBean.conceptSMTKListSelectedEdit}"/>
                                        <f:setPropertyActionListener value=""
                                                                     target="#{findConceptBean.findConcepts}"/>
                                        <p:ajax/>
                                    </p:commandButton>
                                    <p:commandButton rendered="#{not refsetsBean.refSetEdit.valid}"
                                                     icon="fa fa-arrow-up" style="float: right"
                                                     actionListener="#{refsetsBean.validRefset(refsetsBean.refSetEdit)}"
                                                     update="formRefset">
                                        <p:confirm header="Confirmar Acción" message="¿Desea validar este RefSet?"
                                                   icon="ui-icon-alert"/>
                                    </p:commandButton>
                                    <p:commandButton ajax="false" icon="fa fa-file-excel-o" style="float: right">
                                        <p:dataExporter type="xls" target="concepts" fileName="#{refsetsBean.refSetEdit.name}" />
                                    </p:commandButton>
                                </div>
                                <div class="ui-g-12 ui-md-12 ui-lg-12">
                                    <p:dataTable id="concepts" emptyMessage="No se han agregado conceptos al RefSets" reflow="true"
                                                 value="#{refsetsBean.refSetEdit.concepts}" var="conceptSMTK" styleClass="conceptBindRefset">

                                        <p:column headerText="ID">
                                            <h:outputText value="#{conceptSMTK.conceptID}"/>
                                        </p:column>

                                        <p:column headerText="Preferida">
                                            <h:outputText value="#{conceptSMTK.descriptionFavorite.term}"/>
                                        </p:column>

                                        <p:column headerText="Categoría">
                                            <h:outputText value="#{conceptSMTK.category.name}"/>
                                        </p:column>

                                        <p:column headerText="Acción" exportable="false">
                                            <div style="text-align: center">
                                                <p:commandButton icon="fa fa-trash"
                                                                 title="Eliminar concepto del RefSets"
                                                                 ajax="true"
                                                                 process="@this"
                                                                 actionListener="#{refsetsBean.removeConcept(refsetsBean.refSetEdit,conceptSMTK)}"
                                                                 update="@(.conceptBindRefset)"
                                                                 rendered="#{refsetsBean.refSetEdit.valid}">
                                                    <p:confirm header="Confirmación"
                                                               message="¿Está seguro de eliminar este concepto del RefSet?"/>
                                                </p:commandButton>
                                            </div>

                                        </p:column>

                                    </p:dataTable>
                                </div>
                            </div>
                        </div>
                    </p:outputPanel>
                </p:dialog>


                <smtk:addConceptToRefset refset="#{refsetsBean.refSetEdit}"
                                         refsetCreate="#{refsetsBean.refSetToCreate}"/>


                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                    <p:commandButton value="Si" type="button" styleClass="ui-confirmdialog-yes"
                                     icon="ui-icon-check"/>
                    <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no"
                                     icon="ui-icon-close"/>
                </p:confirmDialog>


            </h:form>
        </p:panel>
    </ui:define>
</ui:composition>